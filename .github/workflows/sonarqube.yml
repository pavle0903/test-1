name: SonarQube Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Export JAVA_HOME and PATH
        run: |
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV


      - name: Install and Run SonarScanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: "pavle0903_test-1"    # Replace with your actual project key
          SONAR_ORGANIZATION: "pavle0903"             # Replace with your organization name
          SONAR_HOST_URL: "https://sonarcloud.io"
        run: |
          echo "JAVA_HOME: $JAVA_HOME"
          echo "PATH: $PATH"
          java -version
          # Download SonarScanner CLI
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
          unzip sonar-scanner-cli-4.8.0.2856-linux.zip
          # Add SonarScanner to PATH
          export PATH=$(pwd)/sonar-scanner-4.8.0.2856-linux/bin:$PATH
          echo "Using sonar-scanner version:"
          sonar-scanner --version
          # Run SonarQube analysis and capture all output into run-qg.log
          sonar-scanner \
            -Dsonar.projectKey=$SONAR_PROJECT_KEY \
            -Dsonar.organization=$SONAR_ORGANIZATION \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN 2>&1 | tee run-qg.log

      - name: Show SonarQube Scan Output Log
        run: |
          echo "=== Contents of run-qg.log ==="
          cat run-qg.log



# name: Build
# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     types: [opened, synchronize, reopened]
# jobs:
#   sonarqube:
#     name: SonarQube
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#         with:
#           fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
#       - name: SonarQube Scan
#         uses: SonarSource/sonarqube-scan-action@v4
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

#       - name: Post sonar result to pr
#         run: |
#           PR_NUMBER=${{ github.event.pull_request.number }}
#           STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
#             "https://sonarcloud.io/api/qualitygates/project_status?projectKey=pavle0903_test-1&pullRequest=${{ github.event.pull_request.number }}" | jq -r .projectStatus.status)

#           echo "PR number: $PR_NUMBER"
#           echo "Quality gate status: $STATUS"
          
#           if [[ "$STATUS" == "ERROR" ]]; then
#             echo "‚ùå SonarQube Quality Gate Failed"
#             gh pr comment $PR_NUMBER --body "üö® **SonarQube Quality Gate for [$SONAR_PROJECT]($SONAR_LINK) failed!** Please fix the reporrted issues!"
#           else
#             echo "SonarQube passed"
#           fi
#         env:
#           GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


            # curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            #      -H "Accept: application/vnd.github.v3+json" \
            #      https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            #      -d '{"body": "üö® **SonarQube Quality Gate Failed!** Please fix the reported issues."}'
            # exit 1
