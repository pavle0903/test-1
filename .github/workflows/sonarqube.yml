name: Build
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        #uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          SonarSource/sonarqube-scan-action@v4 \
            -Dsonar.projectKey=pavle0903_test-1 \
            -Dsonar.organization=my-org \
            -Dsonar.host.url=https://sonarcloud.io \
            2>&1 | tee sonar-run.log

      - name: extract sonarqube status
        run: |
          STATUS=$(grep -oP 'Quality gate status: \K(OK|ERROR|WARN)' sonar-run.log)
          echo "Extracted SonarQube Status: $STATUS"

          
          if [[ "$STATUS" == "ERROR" ]]; then
            echo "‚ùå SonarQube Quality Gate Failed"
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "üö® **SonarQube Quality Gate for [pavle0903_test-1](https://sonarcloud.io/project/overview?id=pavle0903_test-1) failed!** Please fix the reported issues."
            exit 1
          else
            echo "‚úÖ SonarQube Passed, no comment needed."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # - name: Post sonar result to pr
      #   run: |
      #     PR_NUMBER=${{ github.event.pull_request.number }}
      #     STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.SONAR_TOKEN }}" \
      #       "https://sonarcloud.io/api/qualitygates/project_status?projectKey=pavle0903_test-1&pullRequest=${{ github.event.pull_request.number }}" | jq -r .projectStatus.status)

      #     echo "PR number: $PR_NUMBER"
      #     echo "Quality gate status: $STATUS"
          
      #     if [[ "$STATUS" == "ERROR" ]]; then
      #       echo "‚ùå SonarQube Quality Gate Failed"
      #       gh pr comment $PR_NUMBER --body "üö® **SonarQube Quality Gate for [$SONAR_PROJECT]($SONAR_LINK) failed!** Please fix the reporrted issues!"
      #     else
      #       echo "SonarQube passed"
      #     fi
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


            # curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            #      -H "Accept: application/vnd.github.v3+json" \
            #      https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            #      -d '{"body": "üö® **SonarQube Quality Gate Failed!** Please fix the reported issues."}'
            # exit 1
